name: è‡ªå‹•éƒ¨ç½²åšå®¢åˆ° GitHub Pages

on:
  schedule:
    # æ¯ 5 åˆ†é˜æª¢æŸ¥ä¸€æ¬¡æ–°æ–‡ç« 
    - cron: '*/5 * * * *'
  workflow_dispatch:
    # ä¿ç•™æ‰‹å‹•è§¸ç™¼é¸é …ï¼Œç”¨æ–¼ç·Šæ€¥éƒ¨ç½²
  push:
    branches: [ main ]
    paths:
      # åªæœ‰é€™äº›æ–‡ä»¶è®Šæ›´æ™‚æ‰è§¸ç™¼ï¼Œé¿å…ä¸å¿…è¦çš„éƒ¨ç½²
      - '.github/workflows/**'
      - 'templates/**'
      - 'scripts/**'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ“¦ è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # ä¸ä½¿ç”¨ç·©å­˜ï¼Œé¿å…è·¯å¾‘å•é¡Œ
          
      - name: ğŸ“‹ å®‰è£æ ¹ç›®éŒ„ä¾è³´
        run: npm install
        
      - name: ğŸ“‹ å®‰è£ admin ä¾è³´
        run: |
          cd admin
          npm install

      - name: ğŸ” æª¢æŸ¥æ˜¯å¦æœ‰æ–°ç™¼å¸ƒçš„æ–‡ç« 
        id: check-posts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL || 'https://bvdgbnlzfyygosqtknaw.supabase.co' }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ2ZGdibmx6Znl5Z29zcXRrbmF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NzM3OTQsImV4cCI6MjA3MDA0OTc5NH0.OYPJoXN9LNQuIfyWyDXs0V2BvdbS7Rkw-mXcVskrv4g' }}
        run: |
          # æª¢æŸ¥æ˜¯å¦æœ‰æ–°çš„æˆ–æ›´æ–°çš„å·²ç™¼å¸ƒæ–‡ç« ï¼ˆæœ€è¿‘8åˆ†é˜å…§ï¼‰
          echo "æ­£åœ¨æª¢æŸ¥æ˜¯å¦æœ‰æ–°ç™¼å¸ƒçš„æ–‡ç« ..."
          
          # è¨ˆç®—8åˆ†é˜å‰çš„æ™‚é–“æˆ³
          EIGHT_MINUTES_AGO=$(date -u -d '8 minutes ago' '+%Y-%m-%dT%H:%M:%S.%3NZ' 2>/dev/null || date -u -v-8M '+%Y-%m-%dT%H:%M:%S.000Z')
          echo "æª¢æŸ¥æ™‚é–“é»: $EIGHT_MINUTES_AGO"
          
          # æŸ¥è©¢ Supabase æ˜¯å¦æœ‰æœ€è¿‘ç™¼å¸ƒæˆ–æ›´æ–°çš„æ–‡ç« 
          RESPONSE=$(curl -s -X GET \
            "${SUPABASE_URL}/rest/v1/posts?status=eq.published&or=(published_at.gte.${EIGHT_MINUTES_AGO},updated_at.gte.${EIGHT_MINUTES_AGO})" \
            -H "apikey: ${SUPABASE_ANON_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_ANON_KEY}")
            
          # æª¢æŸ¥éŸ¿æ‡‰
          if echo "$RESPONSE" | grep -q '"id"'; then
            ARTICLE_COUNT=$(echo "$RESPONSE" | grep -o '"id"' | wc -l)
            echo "found-changes=true" >> $GITHUB_OUTPUT
            echo "âœ… ç™¼ç¾ $ARTICLE_COUNT ç¯‡æ–°ç™¼å¸ƒæˆ–æ›´æ–°çš„æ–‡ç« "
            echo "æ–‡ç« è©³æƒ…: $RESPONSE"
          else
            echo "found-changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ æ²’æœ‰ç™¼ç¾æ–°ç™¼å¸ƒæˆ–æ›´æ–°çš„æ–‡ç« "
          fi
          
          # å¦‚æœæ˜¯é¦–æ¬¡é‹è¡Œæˆ– docs ç›®éŒ„ä¸å­˜åœ¨ï¼Œå¼·åˆ¶ç”Ÿæˆ
          if [ ! -d "docs" ] || [ ! -f "docs/index.html" ]; then
            echo "found-changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ docs ç›®éŒ„ä¸å®Œæ•´ï¼Œéœ€è¦åˆå§‹ç”Ÿæˆ"
          fi

      - name: ğŸš€ ç”Ÿæˆéœæ…‹åšå®¢
        if: steps.check-posts.outputs.found-changes == 'true' || github.event_name == 'workflow_dispatch'
        run: npm run generate:static
        continue-on-error: true

      - name: ğŸ“ æ›´æ–°éƒ¨ç½²æ™‚é–“æˆ³
        if: steps.check-posts.outputs.found-changes == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          mkdir -p docs
          touch docs/.last-deploy
          
      - name: ğŸ” æª¢æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
        if: steps.check-posts.outputs.found-changes == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          echo "æª¢æŸ¥ docs ç›®éŒ„å…§å®¹:"
          ls -la docs/
          echo "æª¢æŸ¥ä¸»é æ–‡ä»¶:"
          if [ -f "docs/index.html" ]; then
            echo "âœ… index.html å­˜åœ¨"
            head -20 docs/index.html
          else
            echo "âŒ index.html ä¸å­˜åœ¨"
          fi

      - name: ğŸ“„ é…ç½® GitHub Pages
        if: steps.check-posts.outputs.found-changes == 'true' || github.event_name == 'workflow_dispatch'
        uses: actions/configure-pages@v4

      - name: ğŸ“¤ ä¸Šå‚³é é¢æ–‡ä»¶
        if: steps.check-posts.outputs.found-changes == 'true' || github.event_name == 'workflow_dispatch'
        uses: actions/upload-pages-artifact@v3
        with:
          path: './docs'

      - name: ğŸš€ éƒ¨ç½²åˆ° GitHub Pages
        if: steps.check-posts.outputs.found-changes == 'true' || github.event_name == 'workflow_dispatch'
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          # è‡ªå‹•å‰µå»º Pages ç’°å¢ƒ
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ‰ éƒ¨ç½²å®Œæˆé€šçŸ¥
        if: steps.check-posts.outputs.found-changes == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          echo "âœ… åšå®¢éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸŒ è¨ªå•åœ°å€: https://xiaonaofua.github.io/blog2"
          
      - name: â„¹ï¸ ç„¡è®Šæ›´é€šçŸ¥
        if: steps.check-posts.outputs.found-changes == 'false' && github.event_name == 'schedule'
        run: |
          echo "â„¹ï¸ æ²’æœ‰ç™¼ç¾æ–°çš„æ–‡ç« è®Šæ›´ï¼Œè·³ééƒ¨ç½²"